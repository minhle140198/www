{"ast":null,"code":"import _defineProperty from\"/Users/monsama/firetable/www/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _objectWithoutProperties from\"/Users/monsama/firetable/www/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties\";import _toConsumableArray from\"/Users/monsama/firetable/www/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _regeneratorRuntime from\"/Users/monsama/firetable/www/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _objectSpread from\"/Users/monsama/firetable/www/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _slicedToArray from\"/Users/monsama/firetable/www/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect,lazy,Suspense}from\"react\";import{Button,IconButton,Typography,Grid as MuiGrid,Tooltip}from\"@material-ui/core\";import ImportExportIcon from\"@material-ui/icons/ImportExport\";import SettingsIcon from\"@material-ui/icons/Settings\";import Confirmation from\"components/Confirmation\";import DeleteIcon from\"@material-ui/icons/Delete\";import DuplicateIcon from\"@material-ui/icons/FileCopy\";import AddIcon from\"@material-ui/icons/AddCircle\";import useStyles from\"./useStyle\";import Loading from\"../../components/Loading\";import Grid from\"./Grid\";import LongTextEditor from\"../LongTextEditor\";import RichTextEditor from\"../RichTextEditor\";import useFiretable from\"../../hooks/useFiretable\";import{functions}from\"../../firebase\";import{CLOUD_FUNCTIONS}from\"firebase/callables\";import{FieldType,getFieldIcon}from\"../Fields\";import{cellFormatter,onGridRowsUpdated,singleSelectEditor,editable,onSubmit}from\"./grid-fns\";import{EditorProvider}from\"../../util/EditorProvider\";var Hotkeys=lazy(function(){return import(\"./HotKeys\");});var TableHeader=lazy(function(){return import(\"./TableHeader\");});var SearchBox=lazy(function(){return import(\"../SearchBox\");});var DocSelect=lazy(function(){return import(\"../Fields/DocSelect\");});var ColumnEditor=lazy(function(){return import(\"./ColumnEditor/index\");});var deleteAlgoliaRecord=functions.httpsCallable(CLOUD_FUNCTIONS.deleteAlgoliaRecord);function Table(props){var collection=props.collection,filters=props.filters;var _useState=useState([]),_useState2=_slicedToArray(_useState,2),orderBy=_useState2[0],setOrderBy=_useState2[1];var _useFiretable=useFiretable(collection,filters,orderBy),tableState=_useFiretable.tableState,tableActions=_useFiretable.tableActions;var _useState3=useState({row:{},column:{}}),_useState4=_slicedToArray(_useState3,2),selectedCell=_useState4[0],setSelectedCell=_useState4[1];var _useState5=useState({config:undefined,collection:\"\",onSubmit:undefined}),_useState6=_slicedToArray(_useState5,2),search=_useState6[0],setSearch=_useState6[1];useEffect(function(){tableActions.table.set(collection,filters,orderBy);},[collection,filters]);var classes=useStyles();var _useState7=useState(null),_useState8=_slicedToArray(_useState7,2),anchorEl=_useState8[0],setAnchorEl=_useState8[1];var _useState9=useState(),_useState10=_slicedToArray(_useState9,2),header=_useState10[0],setHeader=_useState10[1];var handleCloseHeader=function handleCloseHeader(){setHeader(null);setAnchorEl(null);};var clearSearch=function clearSearch(){setSearch({config:undefined,collection:\"\",onSubmit:undefined});};var docSelect=function docSelect(column){return function(props){return React.createElement(Suspense,{fallback:React.createElement(\"div\",null)},React.createElement(DocSelect,Object.assign({},props,{onSubmit:onSubmit(column.key,props.row),collectionPath:column.collectionPath,config:column.config,setSearch:setSearch})));};};var handleClick=function handleClick(headerProps){return function(event){handleCloseHeader();setAnchorEl(event.currentTarget);setHeader(headerProps);};};var headerRenderer=function headerRenderer(props){var column=props.column;switch(column.key){case\"new\":return React.createElement(\"div\",{className:classes.header},column.name,React.createElement(IconButton,{size:\"small\",onClick:handleClick(props)},React.createElement(AddIcon,null)));default:return React.createElement(Tooltip,{title:props.column.key},React.createElement(MuiGrid,{container:true,className:classes.header,alignItems:\"center\",wrap:\"nowrap\"},React.createElement(MuiGrid,{item:true,onClick:function onClick(){navigator.clipboard.writeText(props.column.key);},className:classes.columnIconContainer},getFieldIcon(props.column.type)),React.createElement(MuiGrid,{item:true,xs:true,onClick:function onClick(){navigator.clipboard.writeText(props.column.key);},className:classes.columnNameContainer},React.createElement(Typography,{variant:\"h6\",noWrap:true,className:classes.columnName,component:\"span\"},props.column.name)),React.createElement(MuiGrid,{item:true},React.createElement(IconButton,{color:orderBy[0]&&orderBy[0].key===column.key?\"primary\":\"default\",disableFocusRipple:true,size:\"small\",onClick:function onClick(){console.log(orderBy,orderBy[0]&&orderBy[0].key===column.key,orderBy[0]&&orderBy[0].direction===\"asc\");if(orderBy[0]&&orderBy[0].key===column.key&&orderBy[0].direction===\"asc\"){var ordering=[{key:column.key,direction:\"desc\"}];tableActions.table.orderBy(ordering);//setOrderBy(ordering) #BROKENINSIDE\n}else{var _ordering=[{key:column.key,direction:\"asc\"}];tableActions.table.orderBy(_ordering);//setOrderBy(ordering) #BROKENINSIDE\n}}},React.createElement(ImportExportIcon,null)),React.createElement(IconButton,{disableFocusRipple:true,size:\"small\",onClick:handleClick(props)},React.createElement(SettingsIcon,null)))));}};var onHeaderDrop=function onHeaderDrop(dragged,target){tableActions.column.reorder(dragged,target);};var columns=[];if(!tableState.loadingColumns&&tableState.columns){columns=tableState.columns.filter(function(column){return!column.hidden;}).map(function(column){return _objectSpread({draggable:true,editable:editable(column.type),resizable:true,//frozen: column.fixed,\nheaderRenderer:headerRenderer,formatter:column.type===FieldType.documentSelect?docSelect(column):cellFormatter(column),editor:column.type===FieldType.singleSelect?singleSelectEditor(column.options):false},column,{width:column.width?column.width>380?380:column.width:150});});columns.push({isNew:true,key:\"new\",name:\"Add column\",type:FieldType.last,width:160,headerRenderer:headerRenderer,formatter:function formatter(props){return React.createElement(React.Fragment,null,React.createElement(Confirmation,{message:{title:\"Delete Row\",body:\"Are you sure you want to delete this row?\",confirm:React.createElement(React.Fragment,null,React.createElement(DeleteIcon,null),\" Delete\")}},React.createElement(IconButton,{color:\"primary\",onClick:function _callee(){return _regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:props.row.ref.delete();_context.next=3;return _regeneratorRuntime.awrap(deleteAlgoliaRecord({id:props.row.ref.id,collection:props.row.ref.parent.path}));case 3:case\"end\":return _context.stop();}}});}},React.createElement(DeleteIcon,null))),React.createElement(IconButton,{color:\"secondary\",onClick:function onClick(){var clonedRow=_objectSpread({},props.row);// remove metadata\ndelete clonedRow.ref;delete clonedRow.rowHeight;delete clonedRow.updatedAt;delete clonedRow.createdAt;tableActions.row.add(clonedRow);}},React.createElement(DuplicateIcon,null)));}});}var rowHeight=tableState.config.rowHeight;var rows=tableState.rows.length!==0?[].concat(_toConsumableArray(tableState.rows.map(function(row){return _objectSpread({rowHeight:rowHeight},row);})),[{}]):[];var RowRenderer=function RowRenderer(props){var renderBaseRow=props.renderBaseRow,rest=_objectWithoutProperties(props,[\"renderBaseRow\"]);if(rows.length===rest.idx+1){return React.createElement(Button,{onClick:function onClick(){addRow();}},\"Add a new row\");}else{return renderBaseRow(rest);}};/**\n   * Intercepting row getter to detect when table is requesting the last local row the bottom and fetch more rows\n   * @param index\n   */var handleRowGetter=function handleRowGetter(index){if(tableState.rowsLimit-index===1){tableActions.row.more();}return rows[index];};var addRow=function addRow(data){if(filters){// adds filter data into the new row\nvar filtersData=filters.reduce(function(accumulator,currentValue){return _objectSpread({},accumulator,_defineProperty({},currentValue.key,currentValue.value));},{});tableActions.row.add(_objectSpread({},filtersData,{},data));}else tableActions.row.add(_objectSpread({},data));};return React.createElement(EditorProvider,null,React.createElement(Suspense,{fallback:React.createElement(Loading,{message:\"Loading header\"})},React.createElement(Hotkeys,{selectedCell:selectedCell}),React.createElement(TableHeader,{tableActions:tableActions,collection:collection,rowHeight:rowHeight,updateConfig:tableActions.table.updateConfig,columns:columns,filters:filters,addRow:addRow})),!tableState.loadingColumns?React.createElement(Grid,{key:\"\".concat(collection,\"-grid\"),onHeaderDrop:onHeaderDrop,rowHeight:rowHeight,columns:columns,RowRenderer:RowRenderer,handleRowGetter:handleRowGetter// TODO: Remove this fixed height using flexbox\n,tableHeight:\"calc(100vh - 120px)\",onGridRowsUpdated:onGridRowsUpdated,rows:rows,resizeColumn:tableActions.column.resize,loadingRows:tableState.loadingRows,addRow:addRow,setSelectedCell:setSelectedCell}):React.createElement(Loading,{message:\"Fetching columns\"}),React.createElement(Suspense,{fallback:React.createElement(Loading,{message:\"Loading helpers\"})},React.createElement(ColumnEditor,{handleClose:handleCloseHeader,anchorEl:anchorEl,column:header&&header.column,actions:tableActions.column}),React.createElement(SearchBox,{searchData:search,clearSearch:clearSearch}),React.createElement(RichTextEditor,null),React.createElement(LongTextEditor,null)));}export default Table;","map":{"version":3,"sources":["/Users/monsama/firetable/www/src/components/Table/index.tsx"],"names":["React","useState","useEffect","lazy","Suspense","Button","IconButton","Typography","Grid","MuiGrid","Tooltip","ImportExportIcon","SettingsIcon","Confirmation","DeleteIcon","DuplicateIcon","AddIcon","useStyles","Loading","LongTextEditor","RichTextEditor","useFiretable","functions","CLOUD_FUNCTIONS","FieldType","getFieldIcon","cellFormatter","onGridRowsUpdated","singleSelectEditor","editable","onSubmit","EditorProvider","Hotkeys","TableHeader","SearchBox","DocSelect","ColumnEditor","deleteAlgoliaRecord","httpsCallable","Table","props","collection","filters","orderBy","setOrderBy","tableState","tableActions","row","column","selectedCell","setSelectedCell","config","undefined","search","setSearch","table","set","classes","anchorEl","setAnchorEl","header","setHeader","handleCloseHeader","clearSearch","docSelect","key","collectionPath","handleClick","headerProps","event","currentTarget","headerRenderer","name","navigator","clipboard","writeText","columnIconContainer","type","columnNameContainer","columnName","console","log","direction","ordering","onHeaderDrop","dragged","target","reorder","columns","loadingColumns","filter","hidden","map","draggable","resizable","formatter","documentSelect","editor","singleSelect","options","width","push","isNew","last","title","body","confirm","ref","delete","id","parent","path","clonedRow","rowHeight","updatedAt","createdAt","add","rows","length","RowRenderer","renderBaseRow","rest","idx","addRow","handleRowGetter","index","rowsLimit","more","data","filtersData","reduce","accumulator","currentValue","value","updateConfig","resize","loadingRows"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, lazy, Suspense } from \"react\";\nimport _isEmpty from \"lodash/isEmpty\";\n\nimport {\n  Button,\n  IconButton,\n  Typography,\n  Grid as MuiGrid,\n  Tooltip,\n} from \"@material-ui/core\";\nimport ImportExportIcon from \"@material-ui/icons/ImportExport\";\nimport SettingsIcon from \"@material-ui/icons/Settings\";\nimport Confirmation from \"components/Confirmation\";\nimport DeleteIcon from \"@material-ui/icons/Delete\";\nimport DuplicateIcon from \"@material-ui/icons/FileCopy\";\nimport AddIcon from \"@material-ui/icons/AddCircle\";\n\nimport useStyles from \"./useStyle\";\n\nimport Loading from \"../../components/Loading\";\nimport Grid from \"./Grid\";\nimport LongTextEditor from \"../LongTextEditor\";\nimport RichTextEditor from \"../RichTextEditor\";\n\nimport useFiretable, {\n  FireTableFilter,\n  FiretableOrderBy,\n} from \"../../hooks/useFiretable\";\nimport { functions } from \"../../firebase\";\nimport { CLOUD_FUNCTIONS } from \"firebase/callables\";\n\nimport { FieldType, getFieldIcon } from \"../Fields\";\nimport {\n  cellFormatter,\n  onCellSelected,\n  onGridRowsUpdated,\n  singleSelectEditor,\n  editable,\n  onSubmit,\n} from \"./grid-fns\";\nimport { EditorProvider } from \"../../util/EditorProvider\";\n\nconst Hotkeys = lazy(() => import(\"./HotKeys\"));\nconst TableHeader = lazy(() => import(\"./TableHeader\"));\nconst SearchBox = lazy(() => import(\"../SearchBox\"));\nconst DocSelect = lazy(() => import(\"../Fields/DocSelect\"));\nconst ColumnEditor = lazy(() => import(\"./ColumnEditor/index\"));\n\nconst deleteAlgoliaRecord = functions.httpsCallable(\n  CLOUD_FUNCTIONS.deleteAlgoliaRecord\n);\n\ninterface Props {\n  collection: string;\n  filters: FireTableFilter[];\n}\n\nfunction Table(props: Props) {\n  const { collection, filters } = props;\n  const [orderBy, setOrderBy] = useState<FiretableOrderBy>([]);\n  const { tableState, tableActions } = useFiretable(\n    collection,\n    filters,\n    orderBy\n  );\n  const [selectedCell, setSelectedCell] = useState<{ row: any; column: any }>({\n    row: {},\n    column: {},\n  });\n\n  const [search, setSearch] = useState({\n    config: undefined,\n    collection: \"\",\n    onSubmit: undefined,\n  });\n\n  useEffect(() => {\n    tableActions.table.set(collection, filters, orderBy);\n  }, [collection, filters]);\n\n  const classes = useStyles();\n  const [anchorEl, setAnchorEl] = useState<HTMLButtonElement | null>(null);\n\n  const [header, setHeader] = useState<any | null>();\n\n  const handleCloseHeader = () => {\n    setHeader(null);\n    setAnchorEl(null);\n  };\n  const clearSearch = () => {\n    setSearch({\n      config: undefined,\n      collection: \"\",\n      onSubmit: undefined,\n    });\n  };\n  const docSelect = (column: any) => (props: any) => (\n    <Suspense fallback={<div />}>\n      <DocSelect\n        {...props}\n        onSubmit={onSubmit(column.key, props.row)}\n        collectionPath={column.collectionPath}\n        config={column.config}\n        setSearch={setSearch}\n      />\n    </Suspense>\n  );\n  const handleClick = (headerProps: any) => (\n    event: React.MouseEvent<HTMLButtonElement, MouseEvent>\n  ) => {\n    handleCloseHeader();\n    setAnchorEl(event.currentTarget);\n    setHeader(headerProps);\n  };\n\n  const headerRenderer = (props: any) => {\n    const { column } = props;\n    switch (column.key) {\n      case \"new\":\n        return (\n          <div className={classes.header}>\n            {column.name}\n            <IconButton size=\"small\" onClick={handleClick(props)}>\n              <AddIcon />\n            </IconButton>\n          </div>\n        );\n      default:\n        return (\n          <Tooltip title={props.column.key}>\n            <MuiGrid\n              container\n              className={classes.header}\n              alignItems=\"center\"\n              wrap=\"nowrap\"\n            >\n              <MuiGrid\n                item\n                onClick={() => {\n                  navigator.clipboard.writeText(props.column.key);\n                }}\n                className={classes.columnIconContainer}\n              >\n                {getFieldIcon(props.column.type)}\n              </MuiGrid>\n              <MuiGrid\n                item\n                xs\n                onClick={() => {\n                  navigator.clipboard.writeText(props.column.key);\n                }}\n                className={classes.columnNameContainer}\n              >\n                <Typography\n                  variant=\"h6\"\n                  noWrap\n                  className={classes.columnName}\n                  component=\"span\"\n                >\n                  {props.column.name}\n                </Typography>\n              </MuiGrid>\n\n              <MuiGrid item>\n                <IconButton\n                  color={\n                    orderBy[0] && orderBy[0].key === column.key\n                      ? \"primary\"\n                      : \"default\"\n                  }\n                  disableFocusRipple={true}\n                  size=\"small\"\n                  onClick={() => {\n                    console.log(\n                      orderBy,\n                      orderBy[0] && orderBy[0].key === column.key,\n                      orderBy[0] && orderBy[0].direction === \"asc\"\n                    );\n                    if (\n                      orderBy[0] &&\n                      orderBy[0].key === column.key &&\n                      orderBy[0].direction === \"asc\"\n                    ) {\n                      const ordering: FiretableOrderBy = [\n                        { key: column.key, direction: \"desc\" },\n                      ];\n\n                      tableActions.table.orderBy(ordering);\n                      //setOrderBy(ordering) #BROKENINSIDE\n                    } else {\n                      const ordering: FiretableOrderBy = [\n                        { key: column.key, direction: \"asc\" },\n                      ];\n                      tableActions.table.orderBy(ordering);\n                      //setOrderBy(ordering) #BROKENINSIDE\n                    }\n                  }}\n                >\n                  <ImportExportIcon />\n                </IconButton>\n                <IconButton\n                  disableFocusRipple={true}\n                  size=\"small\"\n                  onClick={handleClick(props)}\n                >\n                  <SettingsIcon />\n                </IconButton>\n              </MuiGrid>\n            </MuiGrid>\n          </Tooltip>\n        );\n    }\n  };\n\n  const onHeaderDrop = (dragged: any, target: any) => {\n    tableActions.column.reorder(dragged, target);\n  };\n  let columns: any[] = [];\n  if (!tableState.loadingColumns && tableState.columns) {\n    columns = tableState.columns\n      .filter((column: any) => !column.hidden)\n      .map((column: any) => ({\n        draggable: true,\n        editable: editable(column.type),\n        resizable: true,\n        //frozen: column.fixed,\n        headerRenderer: headerRenderer,\n        formatter:\n          column.type === FieldType.documentSelect\n            ? docSelect(column)\n            : cellFormatter(column),\n        editor:\n          column.type === FieldType.singleSelect\n            ? singleSelectEditor(column.options)\n            : false,\n        ...column,\n        width: column.width ? (column.width > 380 ? 380 : column.width) : 150,\n      }));\n    columns.push({\n      isNew: true,\n      key: \"new\",\n      name: \"Add column\",\n      type: FieldType.last,\n      width: 160,\n      headerRenderer: headerRenderer,\n      formatter: (props: any) => (\n        <>\n          <Confirmation\n            message={{\n              title: \"Delete Row\",\n              body: \"Are you sure you want to delete this row?\",\n              confirm: (\n                <>\n                  <DeleteIcon /> Delete\n                </>\n              ),\n            }}\n          >\n            <IconButton\n              color=\"primary\"\n              onClick={async () => {\n                props.row.ref.delete();\n                await deleteAlgoliaRecord({\n                  id: props.row.ref.id,\n                  collection: props.row.ref.parent.path,\n                });\n              }}\n            >\n              <DeleteIcon />\n            </IconButton>\n          </Confirmation>\n          <IconButton\n            color=\"secondary\"\n            onClick={() => {\n              const clonedRow = { ...props.row };\n              // remove metadata\n              delete clonedRow.ref;\n              delete clonedRow.rowHeight;\n              delete clonedRow.updatedAt;\n              delete clonedRow.createdAt;\n              tableActions.row.add(clonedRow);\n            }}\n          >\n            <DuplicateIcon />\n          </IconButton>\n        </>\n      ),\n    });\n  }\n\n  const rowHeight = tableState.config.rowHeight;\n\n  const rows =\n    tableState.rows.length !== 0\n      ? [...tableState.rows.map((row: any) => ({ rowHeight, ...row })), {}]\n      : [];\n  const RowRenderer = (props: any) => {\n    const { renderBaseRow, ...rest } = props;\n    if (rows.length === rest.idx + 1) {\n      return (\n        <Button\n          onClick={() => {\n            addRow();\n          }}\n        >\n          Add a new row\n        </Button>\n      );\n    } else {\n      return renderBaseRow(rest);\n    }\n  };\n  /**\n   * Intercepting row getter to detect when table is requesting the last local row the bottom and fetch more rows\n   * @param index\n   */\n  const handleRowGetter = (index: number) => {\n    if (tableState.rowsLimit - index === 1) {\n      tableActions.row.more();\n    }\n    return rows[index];\n  };\n  const addRow = (data?: any) => {\n    if (filters) {\n      // adds filter data into the new row\n      const filtersData = filters.reduce(\n        (accumulator: any, currentValue: FireTableFilter) => ({\n          ...accumulator,\n          [currentValue.key]: currentValue.value,\n        }),\n        {}\n      );\n      tableActions.row.add({ ...filtersData, ...data });\n    } else tableActions.row.add({ ...data });\n  };\n  return (\n    <EditorProvider>\n      <Suspense fallback={<Loading message=\"Loading header\" />}>\n        <Hotkeys selectedCell={selectedCell} />\n        <TableHeader\n          tableActions={tableActions}\n          collection={collection}\n          rowHeight={rowHeight}\n          updateConfig={tableActions.table.updateConfig}\n          columns={columns}\n          filters={filters}\n          addRow={addRow}\n        />\n      </Suspense>\n      {!tableState.loadingColumns ? (\n        <Grid\n          key={`${collection}-grid`}\n          onHeaderDrop={onHeaderDrop}\n          rowHeight={rowHeight}\n          columns={columns}\n          RowRenderer={RowRenderer}\n          handleRowGetter={handleRowGetter}\n          // TODO: Remove this fixed height using flexbox\n          tableHeight=\"calc(100vh - 120px)\"\n          onGridRowsUpdated={onGridRowsUpdated}\n          rows={rows}\n          resizeColumn={tableActions.column.resize}\n          loadingRows={tableState.loadingRows}\n          addRow={addRow}\n          setSelectedCell={setSelectedCell}\n        />\n      ) : (\n        <Loading message=\"Fetching columns\" />\n      )}\n      <Suspense fallback={<Loading message=\"Loading helpers\" />}>\n        <ColumnEditor\n          handleClose={handleCloseHeader}\n          anchorEl={anchorEl}\n          column={header && header.column}\n          actions={tableActions.column}\n        />\n\n        <SearchBox searchData={search} clearSearch={clearSearch} />\n        <RichTextEditor />\n        <LongTextEditor />\n      </Suspense>\n    </EditorProvider>\n  );\n}\nexport default Table;\n"]},"metadata":{},"sourceType":"module"}